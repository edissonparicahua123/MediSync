// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & AUTHORIZATION
// ============================================

model User {
  id          String    @id @default(uuid())
  email       String    @unique
  password    String
  firstName   String
  lastName    String
  phone       String?
  address     String? // Added for doctor/staff address
  avatar      String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  preferences Json?

  // Relations
  roleId String
  role   Role   @relation(fields: [roleId], references: [id])

  // User can be a doctor
  doctor  Doctor?
  // User can be a patient
  patient Patient?

  // Activity tracking
  auditLogs     AuditLog[]
  notifications Notification[]
  attendances   Attendance[]
  createdFiles  FileStorage[]

  // Messages
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  // Bed Management Activities
  bedActivities BedActivity[]

  // Auth tokens
  passwordResetTokens PasswordResetToken[]

  @@index([email])
  @@index([roleId])
  @@map("users")
}

// Password Reset Tokens
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("password_reset_tokens")
}

// Token Blacklist for Logout
model TokenBlacklist {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime

  @@map("token_blacklist")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       User[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  resource    String // e.g., "patients", "appointments"
  action      String // e.g., "create", "read", "update", "delete"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  roles RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model RolePermission {
  id           String @id @default(uuid())
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// ============================================
// ADMIN & LOGGING
// ============================================

model AuditLog {
  id         String   @id @default(uuid())
  action     String
  resource   String
  resourceId String?
  changes    Json?
  ipAddress  String?
  userAgent  String?
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@map("audit_logs")
}

model SystemConfig {
  id          String   @id @default(uuid())
  category    String
  key         String   @unique
  value       String
  type        String // STRING, NUMBER, BOOLEAN, JSON
  description String?
  isPublic    Boolean  @default(false)
  updatedAt   DateTime @updatedAt

  @@map("system_configs")
}

model OrganizationConfig {
  id           String   @id @default(uuid())
  hospitalName String
  email        String
  phone        String
  address      String?
  logo         String?
  branding     Json? // Colors, specialized settings
  openingHours Json?
  billing      Json?
  ai           Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("organization_configs")
}

model BackupLog {
  id        String   @id @default(uuid())
  name      String
  type      String // FULL, PARTIAL
  size      String
  status    String // PENDING, COMPLETED, FAILED
  url       String?
  createdAt DateTime @default(now())

  @@map("backup_logs")
}

// ============================================
// PATIENTS
// ============================================

model Patient {
  id                String    @id @default(uuid())
  firstName         String
  lastName          String
  documentNumber    String?   @unique
  dateOfBirth       DateTime
  gender            String // MALE, FEMALE, OTHER
  bloodType         String?
  phone             String
  email             String?
  address           String?
  city              String?
  state             String?
  zipCode           String?
  emergencyContact  String?
  emergencyPhone    String?
  insuranceNumber   String?
  insuranceProvider String?
  allergies         String?
  chronicConditions String?
  notes             String?
  photo             String? // [NEW] Added for frontend avatar
  status            String    @default("ACTIVE") // ACTIVE, INACTIVE, DECEASED
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?

  // Relations
  userId         String?         @unique
  user           User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments   Appointment[]
  medicalRecords MedicalRecord[]
  labOrders      LabOrder[]
  invoices       Invoice[]
  files          FileStorage[]
  beds           Bed[]
  emergencyCases EmergencyCase[]
  pharmacyOrders PharmacyOrder[]

  // Extended patient data
  documents      PatientDocument[]
  familyMembers  PatientFamilyMember[]
  allergyRecords PatientAllergy[]
  vitalSigns     PatientVitalSign[]
  medications    PatientMedication[]
  diagnoses      PatientDiagnosis[]

  @@index([firstName, lastName])
  @@index([phone])
  @@index([email])
  @@map("patients")
}

// Patient Documents
model PatientDocument {
  id         String   @id @default(uuid())
  patientId  String
  patient    Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  type       String // LAB_RESULT, PRESCRIPTION, IMAGING, CONSENT, OTHER
  name       String
  url        String
  mimeType   String?
  size       Int?
  uploadedBy String?
  uploadedAt DateTime @default(now())

  @@index([patientId])
  @@map("patient_documents")
}

// Patient Family Members
model PatientFamilyMember {
  id                 String  @id @default(uuid())
  patientId          String
  patient            Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  firstName          String
  lastName           String
  relationship       String // SPOUSE, PARENT, CHILD, SIBLING, OTHER
  phone              String?
  email              String?
  isEmergencyContact Boolean @default(false)

  @@index([patientId])
  @@map("patient_family_members")
}

// Patient Allergies (detailed)
model PatientAllergy {
  id          String    @id @default(uuid())
  patientId   String
  patient     Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  allergen    String
  reaction    String?
  severity    String    @default("MODERATE") // MILD, MODERATE, SEVERE
  diagnosedAt DateTime?
  notes       String?
  createdAt   DateTime  @default(now())

  @@index([patientId])
  @@map("patient_allergies")
}

// Patient Vital Signs History
model PatientVitalSign {
  id                     String   @id @default(uuid())
  patientId              String
  patient                Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  recordedAt             DateTime @default(now())
  recordedBy             String?
  height                 Float? // cm
  weight                 Float? // kg
  temperature            Float? // Celsius
  bloodPressureSystolic  Int?
  bloodPressureDiastolic Int?
  heartRate              Int? // bpm
  respiratoryRate        Int?
  oxygenSaturation       Float? // %
  glucose                Float? // mg/dL
  notes                  String?

  @@index([patientId])
  @@index([recordedAt])
  @@map("patient_vital_signs")
}

// Patient Current/Historical Medications
model PatientMedication {
  id           String    @id @default(uuid())
  patientId    String
  patient      Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  medicationId String?
  medication   Medication? @relation(fields: [medicationId], references: [id])
  name         String
  dosage       String
  frequency    String
  instructions String?     @map("notes") // Match our service use of 'instructions'
  route        String? // ORAL, IV, IM, TOPICAL, etc
  startDate    DateTime
  endDate      DateTime?
  
  prescribedById String?
  prescribedBy   Doctor?   @relation(fields: [prescribedById], references: [id])
  
  status       String?     @default("ACTIVE") // ACTIVE, INACTIVE
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())

  @@index([patientId])
  @@index([isActive])
  @@map("patient_medications")
}

// Patient Diagnoses
model PatientDiagnosis {
  id            String   @id @default(uuid())
  patientId     String
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  diagnosisCode String? // ICD-10
  diagnosisName String
  diagnosedBy   String?
  diagnosedDate DateTime @default(now())
  status        String   @default("ACTIVE") // ACTIVE, RESOLVED, CHRONIC
  notes         String?
  createdAt     DateTime @default(now())

  @@index([patientId])
  @@index([status])
  @@map("patient_diagnoses")
}

// ============================================
// DOCTORS & SPECIALTIES
// ============================================

model Specialty {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  doctors Doctor[]

  @@map("specialties")
}

model Doctor {
  id              String    @id @default(uuid())
  licenseNumber   String    @unique
  specialization  String?
  yearsExperience Int?
  consultationFee Decimal   @default(0) @db.Decimal(10, 2)
  bio             String?
  isAvailable     Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  // Relations
  userId      String     @unique
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialtyId String?
  specialty   Specialty? @relation(fields: [specialtyId], references: [id])

  appointments   Appointment[]
  schedules      DoctorSchedule[]
  documents      DoctorDocument[]
  medicalRecords MedicalRecord[]
  emergencyCases EmergencyCase[]
  pharmacyOrders PharmacyOrder[]
  prescribedMedications PatientMedication[]
  labOrders      LabOrder[] @relation("DoctorLabOrders")

  @@index([licenseNumber])
  @@map("doctors")
}

model DoctorSchedule {
  id        String   @id @default(uuid())
  dayOfWeek Int // 0 = Sunday, 6 = Saturday
  startTime String // HH:mm format
  endTime   String // HH:mm format
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  doctorId String
  doctor   Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@map("doctor_schedules")
}

model DoctorDocument {
  id        String   @id @default(uuid())
  title     String
  type      String // e.g., "CV", "Diploma", "License", "Contract"
  url       String // Storage URL
  size      Int? // Size in bytes
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  doctorId String
  doctor   Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@map("doctor_documents")
}

// ============================================
// APPOINTMENTS
// ============================================

model Appointment {
  id              String    @id @default(uuid())
  appointmentDate DateTime
  startTime       String // HH:mm format
  endTime         String? // HH:mm format
  reason          String
  type            String    @default("CHECKUP") // CHECKUP, FOLLOW_UP, EMERGENCY, CONSULTATION, SURGERY
  symptoms        String?
  status          String    @default("SCHEDULED") // SCHEDULED, CONFIRMED, IN_PROGRESS, COMPLETED, CANCELLED, NO_SHOW
  priority        String    @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  triageScore     Int? // AI-generated triage score
  triageNotes     String?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])
  doctorId  String
  doctor    Doctor  @relation(fields: [doctorId], references: [id])

  history        AppointmentHistory[]
  medicalRecords MedicalRecord[]

  @@index([patientId])
  @@index([doctorId])
  @@index([appointmentDate])
  @@index([status])
  @@map("appointments")
}

model AppointmentHistory {
  id        String   @id @default(uuid())
  status    String
  notes     String?
  changedBy String?
  createdAt DateTime @default(now())

  // Relations
  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@map("appointment_history")
}

// Check-in/Check-out tracking for appointments
model AppointmentCheckIn {
  id              String    @id @default(uuid())
  appointmentId   String    @unique
  checkedInAt     DateTime  @default(now())
  checkedInBy     String?
  checkedOutAt    DateTime?
  waitTimeMinutes Int?
  notes           String?

  @@map("appointment_check_ins")
}

// Notification Templates
model NotificationTemplate {
  id        String   @id @default(uuid())
  name      String   @unique
  type      String // APPOINTMENT_REMINDER, LAB_READY, PRESCRIPTION_READY, PAYMENT_DUE
  channel   String // EMAIL, SMS, PUSH
  subject   String?
  body      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification_templates")
}

// Notification Preferences per User
model NotificationPreference {
  id                            String  @id @default(uuid())
  userId                        String  @unique
  emailEnabled                  Boolean @default(true)
  smsEnabled                    Boolean @default(false)
  pushEnabled                   Boolean @default(true)
  appointmentReminders          Boolean @default(true)
  labResultsReady               Boolean @default(true)
  prescriptionReady             Boolean @default(true)
  paymentDue                    Boolean @default(true)
  reminderTimeBeforeAppointment Int     @default(24) // hours

  @@map("notification_preferences")
}

// Notification Log for sent notifications
model NotificationLog {
  id        String    @id @default(uuid())
  userId    String?
  type      String
  channel   String // EMAIL, SMS, PUSH
  recipient String
  subject   String?
  message   String
  status    String    @default("PENDING") // PENDING, SENT, FAILED
  sentAt    DateTime?
  error     String?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([status])
  @@map("notification_logs")
}

// ============================================
// MEDICAL RECORDS
// ============================================

model MedicalRecord {
  id             String    @id @default(uuid())
  visitDate      DateTime
  chiefComplaint String
  diagnosis      String
  treatment      String?
  prescriptions  String?
  vitalSigns     Json? // { temperature, bloodPressure, heartRate, respiratoryRate, oxygenSaturation }
  labResults     String?
  notes          String?
  followUpDate   DateTime?
  aiSummary      String? // AI-generated summary
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  patientId     String
  patient       Patient      @relation(fields: [patientId], references: [id])
  doctorId      String
  doctor        Doctor       @relation(fields: [doctorId], references: [id])
  appointmentId String?
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  @@index([patientId])
  @@index([doctorId])
  @@index([visitDate])
  @@map("medical_records")
}

// ============================================
// PHARMACY
// ============================================

model Medication {
  id           String    @id @default(uuid())
  name         String
  genericName  String?
  category     String?
  description  String?
  dosageForm   String? // tablet, capsule, syrup, injection
  strength     String?
  manufacturer String?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  // Relations
  stock     PharmacyStock[]
  movements PharmacyMovement[]
  orders    PharmacyOrder[]
  patientMedications PatientMedication[]

  @@index([name])
  @@map("medications")
}

model PharmacyStock {
  id              String    @id @default(uuid())
  quantity        Int       @default(0)
  minStockLevel   Int       @default(10)
  maxStockLevel   Int       @default(1000)
  unitPrice       Decimal   @db.Decimal(10, 2)
  sellingPrice    Decimal   @db.Decimal(10, 2)
  expirationDate  DateTime?
  batchNumber     String?
  location        String? // shelf/bin location
  lastRestockDate DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  medicationId String
  medication   Medication @relation(fields: [medicationId], references: [id])

  @@index([medicationId])
  @@index([quantity])
  @@map("pharmacy_stock")
}

model PharmacyMovement {
  id              String   @id @default(uuid())
  movementType    String // IN, OUT, ADJUSTMENT, EXPIRED, DAMAGED
  quantity        Int
  reason          String?
  referenceNumber String?
  performedBy     String?
  notes           String?
  resultingStock  Int? // [NEW] Tracking final stock after movement
  unitPrice       Decimal? @db.Decimal(10, 2) // [NEW] Cost price at movement time
  createdAt       DateTime @default(now())

  // Relations
  medicationId String
  medication   Medication @relation(fields: [medicationId], references: [id])

  @@index([medicationId])
  @@index([movementType])
  @@index([createdAt])
  @@map("pharmacy_movements")
}

model PharmacyOrder {
  id           String     @id @default(uuid())
  orderNumber  String     @unique
  medicationId String
  medication   Medication @relation(fields: [medicationId], references: [id])
  quantity     Int
  doctorId     String
  doctor          Doctor?    @relation(fields: [doctorId], references: [id])
  patientId    String
  patient      Patient    @relation(fields: [patientId], references: [id])

  emergencyCaseId String? // [LINK] To Emergency Case
  emergencyCase   EmergencyCase? @relation(fields: [emergencyCaseId], references: [id])

  status String @default("PENDING") // PENDING, APPROVED, REJECTED, DISPENSED

  createdAt       DateTime  @default(now())
  requestedAt     DateTime  @default(now())
  approvedAt      DateTime?
  approvedBy      String?
  rejectedAt      DateTime?
  rejectedBy      String?
  rejectionReason String?
  updatedAt DateTime @updatedAt

  @@index([medicationId])
  @@index([doctorId])
  @@index([patientId])
  @@index([status])
  @@map("pharmacy_orders")
}

// ============================================
// LABORATORY
// ============================================

model LabTest {
  id          String   @id @default(uuid())
  name        String
  category    String   // Hematology, Chemistry, etc.
  description String?
  normalRange String?
  unit        String?
  price       Decimal  @default(0) @db.Decimal(10, 2)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orders      LabOrder[]

  @@map("lab_tests")
}

model LabOrder {
  id                String    @id @default(uuid())
  orderNumber       String    @unique
  priority          String    @default("NORMAL") // ROUTINE, URGENT, STAT
  status            String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, CANCELLED
  sampleType        String?   // blood, urine, stool, etc.
  sampleCollectedAt DateTime?
  notes             String?
  resultFile        String?   // [NEW] Added for actual file storage path
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])
  
  doctorId  String? 
  doctor    Doctor? @relation("DoctorLabOrders", fields: [doctorId], references: [id])

  testId    String? 
  test      LabTest? @relation(fields: [testId], references: [id])

  // For compatibility with legacy data
  testType  String?
  testName  String?

  results   LabResult[]

  @@index([patientId])
  @@index([orderNumber])
  @@index([status])
  @@map("lab_orders")
}

model LabResult {
  id             String    @id @default(uuid())
  testName       String
  result         String
  unit           String?
  referenceRange String?
  status         String    @default("PENDING") // PENDING, NORMAL, ABNORMAL, CRITICAL
  notes          String?
  performedBy    String?
  verifiedBy     String?
  resultDate     DateTime?
  attachmentUrl  String?   // [NEW] URL for result document
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  labOrderId String
  labOrder   LabOrder @relation(fields: [labOrderId], references: [id], onDelete: Cascade)

  @@index([labOrderId])
  @@map("lab_results")
}

// ============================================
// BILLING & INVOICING
// ============================================

model Invoice {
  id                   String    @id @default(uuid())
  invoiceNumber        String    @unique
  invoiceDate          DateTime  @default(now())
  dueDate              DateTime?
  subtotal             Decimal   @db.Decimal(10, 2)
  tax                  Decimal   @default(0) @db.Decimal(10, 2)
  discount             Decimal   @default(0) @db.Decimal(10, 2)
  total                Decimal   @db.Decimal(10, 2)
  status               String    @default("PENDING") // PENDING, PAID, PARTIALLY_PAID, OVERDUE, CANCELLED
  notes                String?
  
  // Payment-related fields
  paymentMethod        String? // Efectivo, Transferencia BCP, Yape, Plin, etc.
  paymentDate          DateTime?
  destinationAccountId String? // ID of company account where payment was received
  operationNumber      String? // Reference/transaction number
  
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  deletedAt            DateTime?

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  items    InvoiceItem[]
  payments Payment[]

  @@index([patientId])
  @@index([invoiceNumber])
  @@index([status])
  @@map("invoices")
}

model InvoiceItem {
  id          String  @id @default(uuid())
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)

  // Relations
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

model Payment {
  id              String   @id @default(uuid())
  paymentDate     DateTime @default(now())
  amount          Decimal  @db.Decimal(10, 2)
  paymentMethod   String // CASH, CARD, TRANSFER, INSURANCE
  referenceNumber String?
  notes           String?
  createdAt       DateTime @default(now())

  // Relations
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
  @@map("payments")
}

// ============================================
// ATTENDANCE
// ============================================

model Attendance {
  id          String    @id @default(uuid())
  checkIn     DateTime
  checkOut    DateTime?
  hoursWorked Decimal?  @db.Decimal(5, 2)
  tardiness   Int       @default(0) // [NEW] In minutes
  status      String    @default("PRESENT") // PRESENT, LATE, ABSENT, HALF_DAY
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  userId     String?
  user       User?     @relation(fields: [userId], references: [id])
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id])

  @@index([userId])
  @@index([employeeId])
  @@index([checkIn])
  @@map("attendances")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id                String    @id @default(uuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id])
  type              String // APPOINTMENT_REMINDER, SYSTEM_ALERT, etc.
  title             String
  message           String
  isRead            Boolean   @default(false)
  readAt            DateTime?
  relatedEntityType String? // APPOINTMENT, LAB_RESULT, BILLING
  relatedEntityId   String?
  link              String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

// ============================================
// FILE STORAGE
// ============================================

model FileStorage {
  id           String    @id @default(uuid())
  fileName     String
  originalName String
  mimeType     String
  size         Int
  path         String
  category     String? // MEDICAL_RECORD, LAB_RESULT, PRESCRIPTION, OTHER
  description  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  // Relations
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  patientId    String?
  patient      Patient? @relation(fields: [patientId], references: [id])

  @@index([uploadedById])
  @@index([patientId])
  @@index([category])
  @@map("file_storage")
}

// ============================================
// HR MODULE - EMPLOYEE MANAGEMENT
// ============================================

model Employee {
  id               String    @id @default(uuid())
  name             String
  photo            String? // [NEW] From frontend mock
  role             String
  area             String? // [NEW] From frontend mock (e.g. "Cardiolog√≠a")
  department       String
  email            String    @unique
  phone            String?
  documentId       String?   @unique // [NEW] DNI/Passport
  birthDate        DateTime? // [NEW]
  gender           String? // [NEW]
  salary           Decimal?  @db.Decimal(10, 2)
  bonus            Decimal?  @default(0) @db.Decimal(10, 2) // [NEW] Fixed bonus
  contract         String? // [NEW] From frontend mock (e.g. "Tiempo Completo")
  hireDate         DateTime
  isActive         Boolean   @default(true)
  status           String    @default("ACTIVE") // ACTIVE, VACATION, SICK, INACTIVE
  address          String?
  emergencyContact String?
  emergencyPhone   String?
  bankAccount      String? // [NEW]
  notes            String? // [NEW]
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?

  // Relations
  attendances Attendance[]
  shifts      EmployeeShift[]
  payrolls    Payroll[]

  @@index([email])
  @@map("employees")
}

model EmployeeShift {
  id        String   @id @default(uuid())
  startTime DateTime
  endTime   DateTime
  type      String // MORNING, AFTERNOON, NIGHT, GUARD
  status    String   @default("SCHEDULED") // SCHEDULED, COMPLETED, ABSENT, SWAPPED
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([startTime])
  @@map("employee_shifts")
}

model Payroll {
  id          String    @id @default(uuid())
  periodStart DateTime
  periodEnd   DateTime
  baseSalary  Decimal   @db.Decimal(10, 2)
  bonuses     Decimal   @default(0) @db.Decimal(10, 2)
  deductions  Decimal   @default(0) @db.Decimal(10, 2)
  netSalary   Decimal   @db.Decimal(10, 2)
  status      String    @default("DRAFT") // DRAFT, PROCESSED, PAID
  paidDate    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@map("payrolls")
}

// ============================================
// BED MANAGEMENT
// ============================================

model Bed {
  id        String   @id @default(uuid())
  number    String   @unique // e.g., CAM-001
  ward      String // e.g., Emergencia, UCI
  type      String // e.g., Camilla, Cama Hospitalaria
  status    String   @default("AVAILABLE") // AVAILABLE, OCCUPIED, CLEANING, MAINTENANCE, RESERVED
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Occupancy details
  admissionDate      DateTime?
  estimatedDischarge DateTime?
  diagnosis          String?
  specialty          String?

  // Relations
  patientId String?
  patient   Patient? @relation(fields: [patientId], references: [id])

  activities     BedActivity[]
  emergencyCases EmergencyCase[]

  @@map("beds")
}

model BedActivity {
  id        String   @id @default(uuid())
  action    String // RESERVA, ASIGNACION, ALTA, LIMPIEZA
  details   String?
  timestamp DateTime @default(now())

  // Relations
  bedId  String
  bed    Bed     @relation(fields: [bedId], references: [id], onDelete: Cascade)
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  @@index([bedId])
  @@map("bed_activities")
}

// ============================================
// EMERGENCY MODULE - BED MANAGEMENT & TRIAGE
// ============================================

model EmergencyCase {
  id            String   @id @default(uuid())
  patientName   String // Dynamic or real
  patientAge    Int?
  patientId     String? // Optional link to real patient
  patient       Patient? @relation(fields: [patientId], references: [id])
  admissionDate DateTime @default(now())

  // Triage & Vitals
  triageLevel    Int // 1 (Critical) to 5 (Non-Urgent)
  chiefComplaint String
  diagnosis      String?
  vitalSigns     Json? // { hr, bp, temp, spo2 }

  // Location & Staff
  bedId     String?
  bed             Bed?     @relation(fields: [bedId], references: [id])
  bedNumber String? // Keep for caching/display

  doctorId   String?
  doctor          Doctor?  @relation(fields: [doctorId], references: [id])
  doctorName String? // Keep for caching/display

  status       String    @default("ADMITTED") // TRIAGE, ADMITTED, DISCHARGED, OBSERVATION
  notes        String?
  dischargedAt DateTime?

  // Extended clinical data
  vitalSignsHistory EmergencyVitalSign[]
  medications       EmergencyMedication[]
  procedures        EmergencyProcedure[]
  attachments       EmergencyAttachment[]
  pharmacyOrders    PharmacyOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("emergency_cases")
}

model EmergencyVitalSign {
  id              String        @id @default(uuid())
  emergencyCaseId String
  emergencyCase   EmergencyCase @relation(fields: [emergencyCaseId], references: [id], onDelete: Cascade)
  
  hr   Float?
  bp   String?
  temp Float?
  spo2 Float?
  rr   Float?
  
  performedBy String?
  createdAt  DateTime @default(now())

  @@index([emergencyCaseId])
  @@map("emergency_vital_signs")
}

model EmergencyMedication {
  id              String        @id @default(uuid())
  emergencyCaseId String
  emergencyCase   EmergencyCase @relation(fields: [emergencyCaseId], references: [id], onDelete: Cascade)
  
  medicationId   String? // [LINK] To Pharmacy inventory
  name           String
  dosage         String
  route          String // ORAL, IV, IM, etc.
  administeredBy String?
  administeredAt DateTime @default(now())
  notes          String?

  @@index([emergencyCaseId])
  @@map("emergency_medications")
}

model EmergencyProcedure {
  id              String        @id @default(uuid())
  emergencyCaseId String
  emergencyCase   EmergencyCase @relation(fields: [emergencyCaseId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  performedBy String?
  performedAt DateTime @default(now())
  result      String?

  @@index([emergencyCaseId])
  @@map("emergency_procedures")
}

model EmergencyAttachment {
  id              String        @id @default(uuid())
  emergencyCaseId String
  emergencyCase   EmergencyCase @relation(fields: [emergencyCaseId], references: [id], onDelete: Cascade)
  
  title     String
  url       String
  type      String // IMAGE, DOCUMENT, PDF
  createdAt DateTime @default(now())

  @@index([emergencyCaseId])
  @@map("emergency_attachments")
}

// ============================================
// MESSAGING
// ============================================

model Message {
  id             String    @id @default(uuid())
  fromUserId     String
  fromUser       User      @relation("SentMessages", fields: [fromUserId], references: [id])
  toUserId       String
  toUser         User      @relation("ReceivedMessages", fields: [toUserId], references: [id])
  subject        String?
  content        String
  isRead         Boolean   @default(false)
  readAt         DateTime?
  priority       String    @default("NORMAL")
  // Attachment fields
  attachmentUrl  String?
  attachmentName String?
  attachmentType String? // MIME type
  attachmentSize Int? // Size in bytes
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  @@index([fromUserId])
  @@index([toUserId])
  @@index([isRead])
  @@index([createdAt])
  @@map("messages")
}

// ============================================
// SERVICES CATALOG
// ============================================

model ServiceCatalog {
  id          String   @id @default(uuid())
  name        String
  description String?
  price       Float
  category    String   // "CONSULTA", "EXAMEN", "PROCEDIMIENTO", "TERAPIA"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([isActive])
  @@map("services_catalog")
}
